/*
 * fsm_simple_buttons.c
 *
 *  Created on: Nov 5, 2022
 *      Author: Admin
 */
#include "fsm_simple_buttons.h"
#include "global.h"
#include "button_reading.h"
#include "led_display.h"
#include "timer.h"

enum State {COUNTDOWN, INIT, RESET_0, DEC, INC, INC_1S , DEC_1S , SETTIME, INIT1};
enum State  currentState = COUNTDOWN;
enum State  nextState = COUNTDOWN;

enum State  status = INIT1;
enum State nextstatus = INIT1;

//int flag = 0;
//void fsm_simple_buttons_run(){
//	currentState = nextState;
//	switch(currentState){
//		case INIT:
//			if(flag == 0){
//				count_down();
//			}
//			if(button_flag[0]== 1){
//				flag = 1;
//				button_flag[0] = 0;
//				nextState = RESET_0;
//			}
//			if(button_flag_pressed_3s[1] == 1){
//				flag = 1;
//				nextState = INC_1S;
//				setTimer1(1000);
//			}
//			if(button_flag_pressed_3s[2] == 1){
//				flag = 1;
//				nextState = DEC_1S;
//				setTimer1(1000);
//			}
//			if(button_flag[1] == 1 ){
//				flag = 1;
//				button_flag[1] = 0;
//				nextState = INC;
//			}
//			if(button_flag[2] == 1 ){
//				flag = 1;
//				button_flag[2] = 0;
//				nextState = DEC;
//			}
//	    	break;
//		case RESET_0:
//			counter = 0;
//			display7SEG(counter);
//			if(button_flag[0]== 0){
//				nextState = INIT;
//			}
//			break;
//		case INC:
//	    	counter++;
//	    	if(counter > 9){
//	    		counter = 0;
//	    	}
//	    	display7SEG(counter);
//	    	if (button_flag[1] == 0){
//	    		nextState = INIT;
//	    	}
//			break;
//		case INC_1S:
//			if(timer1_flag==1){
//				setTimer1(1000);
//				counter++;
//				if(counter > 9) {
//					counter = 0;
//				}
//				display7SEG(counter);
//			}
//			if(button_flag_pressed_3s[1] == 0){
//				setTimer1(1000);
//				nextState = INIT;
//			}
//			break;
//		case DEC:
//			counter--;
//	    	if(counter < 0){
//	    		counter = 9;
//	    	}
//	    	display7SEG(counter);
//	    	if(button_flag[2] == 0){
//	    		nextState= INIT;
//	    	}
//	    	break;
//		case DEC_1S:
//			if(timer1_flag==1){
//				setTimer1(1000);
//				counter--;
//				if(counter < 0) {
//					counter = 9;
//				}
//				display7SEG(counter);
//			}
//			if(button_flag_pressed_3s[2] == 0){
//				setTimer1(1000);
//				nextState = INIT;
//			}
//			break;
//		default:
//			break;
//	}
//}

//void fsm_button_pressed(){
//	status = nextstatus;
//	switch(status){
//		case INIT1:
//			if(is_pressed(0) == 0 && is_pressed(1) == 0 && is_pressed(2) == 0){
//				nextstatus = SETTIME;
//				setTimer2(10000);
//			}
//			break;
//		case SETTIME:
//			if(timer2_flag == 1){
//				flag = 0;
//			}
//			break;
//		default:
//			break;
//	}
//}
//

int flag = 0;
void fsm_simple_buttons_run(){
	currentState = nextState;
	switch(currentState){
	    case COUNTDOWN:
	        count_down();
	        if(button_flag[0] == 1 || button_flag[1] == 1 || button_flag[2] == 1){
				nextState = INIT;
				setTimer2(10000);
			}
		case INIT:
		    if(button_flag[0] == 1 || button_flag[1] == 1 || button_flag[2] == 1){
				setTimer2(10000);
			}
			if(timer2_flag){
			    nextState = COUNTDOWN;
			}
			if(button_flag[0]== 1){
				flag = 1;
				button_flag[0] = 0;
				nextState = RESET_0;
			}
			if(button_flag_pressed_3s[1] == 1){
				flag = 1;
				nextState = INC_1S;
				setTimer1(1000);
			}
			if(button_flag_pressed_3s[2] == 1){
				flag = 1;
				nextState = DEC_1S;
				setTimer1(1000);
			}
			if(button_flag[1] == 1 ){
				flag = 1;
				button_flag[1] = 0;
				nextState = INC;
			}
			if(button_flag[2] == 1 ){
				flag = 1;
				button_flag[2] = 0;
				nextState = DEC;
			}
	    	break;
		case RESET_0:
			counter = 0;
			display7SEG(counter);
			if(button_flag[0]== 0){
				nextState = INIT;
			}
			break;
		case INC:
	    	counter++;
	    	if(counter > 9){
	    		counter = 0;
	    	}
	    	display7SEG(counter);
	    	if (button_flag[1] == 0){
	    		nextState = INIT;
	    	}
			break;
		case INC_1S:
			if(timer1_flag==1){
				setTimer1(1000);
				counter++;
				if(counter > 9) {
					counter = 0;
				}
				display7SEG(counter);
			}
			if(button_flag_pressed_3s[1] == 0){
				setTimer1(1000);
				nextState = INIT;
			}
			break;
		case DEC:
			counter--;
	    	if(counter < 0){
	    		counter = 9;
	    	}
	    	display7SEG(counter);
	    	if(button_flag[2] == 0){
	    		nextState= INIT;
	    	}
	    	break;
		case DEC_1S:
			if(timer1_flag==1){
				setTimer1(1000);
				counter--;
				if(counter < 0) {
					counter = 9;
				}
				display7SEG(counter);
			}
			if(button_flag_pressed_3s[2] == 0){
				setTimer1(1000);
				nextState = INIT;
			}
			break;
// 		case SETTIME:
// 			if(timer2_flag == 1){
// 				flag = 0;
// 				nextState = INIT;
// 			}
// 			break;
		default:
			break;
	}
}

